#!/bin/bash
# Master script for Thugdor
set -o nounset
set -o errexit

# CONFIGURATION
#
# TARGET
TARGET=$1

# OUTPUT DIRECTORIES
HOMEDIR="/home/matt"
REPORTDIR="${HOMEDIR}/MalwareReports"
THUGREPORTS="${REPORTDIR}/Thug"
EYEWITNESS="${REPORTDIR}/Eyewitness"
URLLIST="${HOMEDIR}/MalwareReports/malware-checks.txt"
URLDUMPS="${REPORTDIR}/url_dumps"
TMPTHUGREPORTS="/tmp/thug-reports-$$.txt"
EYEWITNESSIN="${EYEWITNESS}/eyewitness.txt"
# SCRIPTS AND BINARIES
PYTHON="/usr/bin/python"
URLDUMPER="${HOMEDIR}/Github/Malware/Thug/url-dumper.py"
THUGPARSE="${HOMEDIR}/Github/Malware/Thug/thug-parse.py"
SPIDER="${HOMEDIR}/Github/Malware/Thug/spider.py"
EYEWITNESS="${HOMEDIR}/Github/EyeWitness/EyeWitness.py"
# THUG AND OPTIONS
THUG="/opt/tools/thug/src/thug.py"
THUGUA="win7ie90"
THUGOPTS="-q -y"
THUGTIMEOUT="10"
THUGANALYSIS="analysis.json"


echo "[ Thugdor v0.1 ]"
echo
echo -n " * Running Spider"
${PYTHON} ${SPIDER} -u ${TARGET} -f ${URLLIST} -a
echo 

echo -n " * Running URL Dump script for Thug analysis"
test -d ${URLDUMPS} && true || mkdir -p ${URLDUMPS} 
${PYTHON} ${URLDUMPER} -f ${URLLIST} -d ${URLDUMPS}
echo 

echo -n " * Running Thug on local files"
for URL in ${URLDUMPS}/*
    do 
	${PYTHON} ${THUG} -u ${THUGUA} ${THUGOPTS} -T ${THUGTIMEOUT} -n ${THUGREPORTS}/${URL} -l ${URL}
done

echo 

echo -n " * Running Thug parsing script on Thug reports"
find ${THUGREPORTS} -name ${THUGANALYSIS} >> ${TMPTHUGREPORTS}
for THUG in `cat ${TMPTHUGREPORTS}`
    do
	${PYTHON} ${THUGPARSE} -r ${THUG} -o ${EYEWITNESSIN}
done

echo

echo -n " * Running Eyewitness on any malicious links found"
test -d ${EYEWITNESSIN} &&  ${EYEWITNESS} --skipcreds --useragent \
    "Mozilla/5.0 (compatible; Googlebot/2.1; +http://www.google.com/bot.html)" \
    -t 10 -f ${EYEWITNESSIN} \
    || echo " [ No malicious links to grab ] "
echo

echo "[ Complete ]"
rm -f ${TMPTHUGREPORTS} > /dev/null 2>&1
